<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Molleiros Decor | Sistema Profissional Total</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<style>
:root{
 --rosa:#f8c8dc;--rosa2:#f4b3cd;--amarelo:#fff1c1;--texto:#555;
}
body{font-family:'Segoe UI',sans-serif;background:#fff7fb;margin:0;color:var(--texto)}
header{background:var(--rosa);padding:15px;text-align:center}
header img{height:80px}
section{background:#fff;max-width:1300px;margin:20px auto;padding:20px;border-radius:20px;box-shadow:0 0 16px rgba(0,0,0,.06)}
h2,h3{color:#d96c9a;margin-top:0}
label{display:block;margin-top:8px;font-size:14px}
input,select,textarea{width:100%;padding:8px;border-radius:8px;border:1px solid #ddd}
button{background:var(--rosa);border:none;padding:10px 18px;border-radius:10px;margin:6px 4px 0 0;cursor:pointer}
button:hover{background:var(--rosa2)}
.flex{display:flex;gap:12px;flex-wrap:wrap}
.flex>div{flex:1}
table{width:100%;border-collapse:collapse;margin-top:10px}
th,td{border:1px solid #eee;padding:6px;font-size:13px}
th{background:var(--amarelo)}
.total{font-size:22px;font-weight:bold;color:#c64f86;margin-top:15px}
.badge{background:#ffe1ec;padding:6px 10px;border-radius:20px;font-size:13px}
/* PDF */
#contratoPDF{background:linear-gradient(135deg,#ffe6f0,#fff8dc,#e8f7ff);padding:40px;position:relative}
.watermark{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);opacity:0.07;z-index:0}
.watermark img{width:90%}
.content{position:relative;z-index:1;font-size:13px}
@media(max-width:768px){section{margin:10px}}
</style>
</head>
<body>
<header><img src="logo.png"></header>

<section>
<h2>üè¢ Dados da Empresa</h2>
<div class="flex">
<div><label>Nome</label><input id="eNome" value="Molleiros Decor"></div>
<div><label>Cidade</label><input id="eCidade" value="Carapicu√≠ba / SP"></div>
<div><label>Contato</label><input id="eContato" value="WhatsApp"></div>
</div>
</section>

<section>
<h2>üë©‚Äçüëß Cliente</h2>
<div class="flex">
<div><label>Nome</label><input id="nome"></div>
<div><label>CPF</label><input id="cpf"></div>
<div><label>Telefone</label><input id="telefone"></div>
<div><label>Email</label><input id="email"></div>
</div>
<label>Endere√ßo</label><input id="endereco">
<button onclick="salvarCliente()">Salvar Cliente</button>
<select id="listaClientes" onchange="carregarCliente()"></select>
</section>

<section>
<h2>üéâ Evento</h2>
<div class="flex">
<div><label>Data</label><input type="date" id="dataEvento"></div>
<div><label>Local</label><input id="localEvento"></div>
<div><label>Retirada</label><input id="horaRetirada"></div>
<div><label>Devolu√ß√£o</label><input id="horaDevolucao"></div>
</div>
</section>

<section>
<h2>üì¶ Cat√°logo & Estoque</h2>
<div class="flex">
<div><label>Item</label><input id="catItem"></div>
<div><label>Valor</label><input type="number" id="catValor"></div>
<div><label>Estoque</label><input type="number" id="catEstoque"></div>
</div>
<button onclick="addCatalogo()">Adicionar ao Cat√°logo</button>
<table id="tCatalogo"><tr><th>Item</th><th>Valor</th><th>Estoque</th></tr></table>
</section>

<section>
<h2>üì¶ Itens do Contrato</h2>
<select id="catalogo" onchange="preencheCatalogo()"></select>
<div class="flex">
<div><label>Item</label><input id="item"></div>
<div><label>Qtd</label><input type="number" id="qtd"></div>
<div><label>Valor Unit.</label><input type="number" id="valor"></div>
</div>
<button onclick="addItem()">Adicionar Item</button>
<table id="tItens"><tr><th>Item</th><th>Qtd</th><th>Valor</th><th>Subtotal</th></tr></table>

<h3>‚ö†Ô∏è Avarias / Extravios</h3>
<div class="flex">
<div><label>Tipo</label><select id="tipo"><option>Avaria</option><option>Extravio</option></select></div>
<div><label>Descri√ß√£o</label><input id="desc"></div>
<div><label>Valor</label><input type="number" id="valorPenal"></div>
</div>
<button onclick="addPenal()">Adicionar Penalidade</button>
<table id="tPenal"><tr><th>Tipo</th><th>Descri√ß√£o</th><th>Valor</th></tr></table>
<div class="flex" style="margin-top:15px">
<div><label>Valor do Contrato (R$)</label><input type="number" id="valorContrato" oninput="recalcular()"></div>
<div><label>Sinal Recebido (R$)</label><input type="number" id="sinal" oninput="recalcular()"></div>
</div>
<div class="total" id="total">Valor a Receber: R$ 0,00</div>
</section>

<section>
<h2>‚úçÔ∏è Assinatura do Cliente</h2>
<label>Digite o nome para assinatura digital</label>
<input id="assinatura">
</section>

<section>
<h2>üßæ Finaliza√ß√£o</h2>
<button onclick="previewContrato()">üëÅÔ∏è Visualizar Contrato</button>
<button onclick="gerarPDF()">üìÑ Gerar PDF</button>
<button onclick="enviarWhats()">üì≤ Enviar WhatsApp</button>
<button onclick="novoAtendimento()">üîÑ Novo Atendimento</button>
</section>

<section id="previewBox" style="display:none">
<h2>üëÅÔ∏è Pr√©-visualiza√ß√£o do Contrato</h2>
<div style="max-height:500px;overflow:auto;border:1px solid #eee;padding:15px;border-radius:12px">
<div id="previewContrato"></div>
</div>
</section>

<div id="contratoPDF" style="display:none">
<div class="watermark"><img src="logo.png"></div>
<div class="content">
<h2 style="text-align:center">CONTRATO DE LOCA√á√ÉO ‚Äì PEGUE E MONTE</h2>
<p class="badge">Contrato N¬∫ <span id="numContrato"></span></p>
<table>
<tr><td><strong id="cEmpresa"></strong><br><span id="cCidade"></span></td><td><strong>Cliente</strong><br><span id="cCliente"></span><br><span id="cEndereco"></span></td></tr>
</table>
<p><strong>Evento:</strong> <span id="cData"></span> | <span id="cLocal"></span></p>
<p>Retirada: <span id="cRet"></span> | Devolu√ß√£o: <span id="cDev"></span></p>
<h3>Itens Locados</h3><div id="cItens"></div>
<h3>Penalidades</h3><div id="cPenal"></div>
<h2 style="color:#c64f86">VALOR A RECEBER: R$ <span id="cTotal"></span></h2>
<p><strong>Valor do Contrato:</strong> R$ <span id="cValorContrato"></span><br>
<strong>Sinal Recebido:</strong> R$ <span id="cSinal"></span></p>
<p><strong>Assinatura do Cliente:</strong> <span id="cAss"></span></p>
<p>Contrato eletr√¥nico com validade jur√≠dica conforme MP 2.200-2.</p>
</div>
</div>

<script>
let clientes=JSON.parse(localStorage.getItem('clientes'))||[];
let catalogoItens=JSON.parse(localStorage.getItem('catalogo'))||[];
let contratos=JSON.parse(localStorage.getItem('contratos'))||[];
let clienteAtual={},itens=[],penal=[];
let valorContrato=0,sinal=0,totalPenal=0;

function init(){
 listaClientes.innerHTML='<option value="">Clientes salvos</option>';
 clientes.forEach((c,i)=>listaClientes.innerHTML+=`<option value="${i}">${c.nome}</option>`);
 catalogo.innerHTML='<option value="">Selecionar item</option>';
 tCatalogo.innerHTML='<tr><th>Item</th><th>Valor (avaria/extravio)</th><th>Estoque</th></tr>';
 catalogoItens.forEach((c,i)=>{
  catalogo.innerHTML+=`<option value="${i}">${c.item}</option>`;
  tCatalogo.innerHTML+=`<tr><td>${c.item}</td><td>${c.valor}</td><td>${c.estoque}</td></tr>`;
 });
 recalcular();
}
init();

function salvarCliente(){
 clienteAtual={nome:nome.value,cpf:cpf.value,telefone:telefone.value,email:email.value,end:endereco.value};
 clientes.push(clienteAtual);
 localStorage.setItem('clientes',JSON.stringify(clientes));
 init();
 alert('Cliente salvo');
}

function carregarCliente(){
 let c=clientes[listaClientes.value];
 if(!c)return;
 nome.value=c.nome;cpf.value=c.cpf;telefone.value=c.telefone;email.value=c.email;endereco.value=c.end;
 clienteAtual=c;
}

function addCatalogo(){
 catalogoItens.push({item:catItem.value,valor:Number(catValor.value),estoque:catEstoque.value});
 localStorage.setItem('catalogo',JSON.stringify(catalogoItens));
 init();
 catItem.value=catValor.value=catEstoque.value='';
}

function preencheCatalogo(){
 let c=catalogoItens[catalogo.value];
 if(c){item.value=c.item;valor.value=c.valor;}
}

// Itens N√ÉO somam no valor do contrato (apenas controle)
function addItem(){
 itens.push({item:item.value,qtd:qtd.value,valor:valor.value});
 tItens.innerHTML+=`<tr><td>${item.value}</td><td>${qtd.value}</td><td>${valor.value}</td><td>-</td></tr>`;
 item.value=qtd.value=valor.value='';
}

// Penalidades SOMAM no valor final
function addPenal(){
 let v=Number(valorPenal.value)||0;
 totalPenal+=v;
 penal.push({tipo:tipo.value,desc:desc.value,valor:v});
 tPenal.innerHTML+=`<tr><td>${tipo.value}</td><td>${desc.value}</td><td>${v.toFixed(2)}</td></tr>`;
 desc.value=valorPenal.value='';
 recalcular();
}

function recalcular(){
 valorContrato=Number(document.getElementById('valorContrato').value)||0;
 sinal=Number(document.getElementById('sinal').value)||0;
 let receber=(valorContrato - sinal) + totalPenal;
 document.getElementById('total').innerText=`Valor a Receber: R$ ${receber.toFixed(2)}`;
 return receber;
}

function previewContrato(){
 let receber=recalcular();
 document.getElementById('previewContrato').innerHTML=`
 <h3>CONTRATO DE LOCA√á√ÉO ‚Äì PEGUE E MONTE</h3>
 <p><strong>Empresa:</strong> ${eNome.value} ‚Äì ${eCidade.value}</p>
 <p><strong>Cliente:</strong> ${clienteAtual.nome} ‚Äì ${clienteAtual.cpf}</p>
 <p><strong>Evento:</strong> ${dataEvento.value} ‚Äì ${localEvento.value}</p>
 <h4>Itens Locados</h4>
 ${itens.map(i=>`${i.item} (${i.qtd})`).join('<br>')}
 <h4>Penalidades</h4>
 ${penal.map(p=>`${p.tipo}: ${p.desc} ‚Äì R$ ${p.valor.toFixed(2)}`).join('<br>')||'Nenhuma'}
 <p><strong>Valor do Contrato:</strong> R$ ${valorContrato.toFixed(2)}</p>
 <p><strong>Sinal:</strong> R$ ${sinal.toFixed(2)}</p>
 <h3>VALOR A RECEBER: R$ ${receber.toFixed(2)}</h3>
 `;
 document.getElementById('previewBox').style.display='block';
}

function gerarPDF(){
 let receber=recalcular();
 let num=contratos.length+1;
 numContrato.innerText=num;
 cEmpresa.innerText=eNome.value;
 cCidade.innerText=eCidade.value;
 cCliente.innerText=`${clienteAtual.nome} - ${clienteAtual.cpf}`;
 cEndereco.innerText=clienteAtual.end;
 cData.innerText=dataEvento.value;
 cLocal.innerText=localEvento.value;
 cRet.innerText=horaRetirada.value;
 cDev.innerText=horaDevolucao.value;
 cItens.innerHTML=itens.map(i=>`${i.item} (${i.qtd})`).join('<br>');
 cPenal.innerHTML=penal.map(p=>`${p.tipo}: ${p.desc} - R$ ${p.valor.toFixed(2)}`).join('<br>');
 cTotal.innerText=receber.toFixed(2);
 cAss.innerText=assinatura.value;
 cValorContrato.innerText=valorContrato.toFixed(2);
 cSinal.innerText=sinal.toFixed(2);
 contratos.push({num,cliente:clienteAtual,valorContrato,sinal,penal,total:receber});
 localStorage.setItem('contratos',JSON.stringify(contratos));
 contratoPDF.style.display='block';
 html2pdf().from(contratoPDF).set({filename:`Contrato_${num}_${clienteAtual.nome}.pdf`,html2canvas:{scale:2},jsPDF:{format:'a4'}}).save().then(()=>contratoPDF.style.display='none');
}

function enviarWhats(){
 let receber=recalcular();
 let msg=`Ol√° ${clienteAtual.nome}! Seu contrato N¬∫ ${contratos.length} da Molleiros Decor foi gerado. Valor a receber: R$ ${receber.toFixed(2)}`;
 window.open(`https://wa.me/?text=${encodeURIComponent(msg)}`);
}

function novoAtendimento(){location.reload();}
</script>
</body>
</html>
